/**
 * @file helper_storage_health.hpp
 * @brief SD Card and SPIFFS health monitoring and auto-recovery
 * 
 * Detects file system corruption and provides auto-repair capabilities
 * Monitors read/write errors and triggers corrective actions
 */

#pragma once

#include <esp_log.h>
#include <esp_spiffs.h>
#include <sys/stat.h>
#include <dirent.h>
#include <string.h>
#include <time.h>

static const char* STORAGE_TAG = "StorageHealth";

// Error thresholds
#define SD_ERROR_THRESHOLD 5        // Trigger repair after 5 errors
#define SPIFFS_ERROR_THRESHOLD 10   // Trigger repair after 10 errors
#define ERROR_WINDOW_MS 60000       // 60 second error counting window

// Storage health status
typedef struct {
    uint32_t sd_errors;
    uint32_t spiffs_errors;
    uint32_t last_sd_error_time;
    uint32_t last_spiffs_error_time;
    bool sd_needs_repair;
    bool spiffs_needs_repair;
    bool sd_mounted;
    bool spiffs_mounted;
} storage_health_t;

static storage_health_t g_storage_health = {0};

/**
 * @brief Record an SD card error
 */
static inline void storage_health_record_sd_error() {
    uint32_t now = xTaskGetTickCount() * portTICK_PERIOD_MS;
    
    // Reset counter if outside error window
    if (now - g_storage_health.last_sd_error_time > ERROR_WINDOW_MS) {
        g_storage_health.sd_errors = 0;
    }
    
    g_storage_health.sd_errors++;
    g_storage_health.last_sd_error_time = now;
    
    if (g_storage_health.sd_errors >= SD_ERROR_THRESHOLD) {
        ESP_LOGW(STORAGE_TAG, "SD card error threshold reached (%lu errors), flagging for repair", 
                 g_storage_health.sd_errors);
        g_storage_health.sd_needs_repair = true;
    }
}

/**
 * @brief Record a SPIFFS error
 */
static inline void storage_health_record_spiffs_error() {
    uint32_t now = xTaskGetTickCount() * portTICK_PERIOD_MS;
    
    // Reset counter if outside error window
    if (now - g_storage_health.last_spiffs_error_time > ERROR_WINDOW_MS) {
        g_storage_health.spiffs_errors = 0;
    }
    
    g_storage_health.spiffs_errors++;
    g_storage_health.last_spiffs_error_time = now;
    
    if (g_storage_health.spiffs_errors >= SPIFFS_ERROR_THRESHOLD) {
        ESP_LOGW(STORAGE_TAG, "SPIFFS error threshold reached (%lu errors), flagging for repair", 
                 g_storage_health.spiffs_errors);
        g_storage_health.spiffs_needs_repair = true;
    }
}

/**
 * @brief Verify SPIFFS integrity
 * @return true if SPIFFS is healthy
 */
static bool storage_health_verify_spiffs() {
    size_t total = 0, used = 0;
    esp_err_t ret = esp_spiffs_info("storage", &total, &used);
    
    if (ret != ESP_OK) {
        ESP_LOGE(STORAGE_TAG, "SPIFFS info failed: %s", esp_err_to_name(ret));
        return false;
    }
    
    ESP_LOGI(STORAGE_TAG, "SPIFFS health check: %lu/%lu bytes used (%.1f%%)", 
             used, total, (used * 100.0) / total);
    
    return true;
}

/**
 * @brief Verify SD card integrity by checking critical files
 * @return true if SD card is healthy
 */
static bool storage_health_verify_sd() {
    struct stat st;
    const char* critical_file = "/sdcard/settings.json";
    
    if (stat(critical_file, &st) != 0) {
        ESP_LOGW(STORAGE_TAG, "SD card critical file missing: %s", critical_file);
        return false;
    }
    
    // Try to read the file
    FILE* f = fopen(critical_file, "r");
    if (!f) {
        ESP_LOGE(STORAGE_TAG, "SD card read test failed: %s (errno=%d)", critical_file, errno);
        return false;
    }
    fclose(f);
    
    ESP_LOGI(STORAGE_TAG, "SD card health check: OK");
    return true;
}

/**
 * @brief Attempt to repair SPIFFS
 * @return true if repair succeeded
 */
static bool storage_health_repair_spiffs() {
    ESP_LOGW(STORAGE_TAG, "Attempting SPIFFS repair...");
    
    // Unmount and remount with format option
    esp_vfs_spiffs_unregister("storage");
    
    esp_vfs_spiffs_conf_t conf = {
        .base_path = "/spiffs",
        .partition_label = "storage",
        .max_files = 10,
        .format_if_mount_failed = true  // Auto-format on mount failure
    };
    
    esp_err_t ret = esp_vfs_spiffs_register(&conf);
    if (ret != ESP_OK) {
        ESP_LOGE(STORAGE_TAG, "SPIFFS repair failed: %s", esp_err_to_name(ret));
        g_storage_health.spiffs_mounted = false;
        return false;
    }
    
    ESP_LOGI(STORAGE_TAG, "SPIFFS repaired successfully");
    g_storage_health.spiffs_needs_repair = false;
    g_storage_health.spiffs_errors = 0;
    g_storage_health.spiffs_mounted = true;
    
    return true;
}

/**
 * @brief Attempt to repair SD card filesystem
 * @return true if repair succeeded
 */
static bool storage_health_repair_sd() {
    ESP_LOGW(STORAGE_TAG, "SD card repair requested - remounting...");
    
    // For SD card, we can try remounting
    // Full format requires user confirmation via settings UI
    
    extern sdmmc_card_t* g_sd_card;  // Defined in main.cpp
    if (g_sd_card) {
        // Try remounting
        esp_vfs_fat_sdcard_unmount("/sdcard", g_sd_card);
        vTaskDelay(pdMS_TO_TICKS(1000));
        
        // Remount logic would go here (simplified)
        ESP_LOGI(STORAGE_TAG, "SD card remount attempted");
        g_storage_health.sd_needs_repair = false;
        g_storage_health.sd_errors = 0;
        
        return storage_health_verify_sd();
    }
    
    return false;
}

/**
 * @brief Format SD card (requires user confirmation)
 * @return true if format succeeded
 */
static bool storage_health_format_sd() {
    ESP_LOGW(STORAGE_TAG, "⚠️  SD CARD FORMAT INITIATED");
    
    // This should only be called from the settings UI after user confirmation
    extern sdmmc_card_t* g_sd_card;
    if (!g_sd_card) {
        ESP_LOGE(STORAGE_TAG, "SD card not available for format");
        return false;
    }
    
    // Unmount
    esp_vfs_fat_sdcard_unmount("/sdcard", g_sd_card);
    vTaskDelay(pdMS_TO_TICKS(1000));
    
    // Remount with format
    esp_vfs_fat_sdmmc_mount_config_t mount_config = {
        .format_if_mount_failed = true,
        .max_files = 5,
        .allocation_unit_size = 16 * 1024
    };
    
    esp_err_t ret = esp_vfs_fat_sdmmc_mount("/sdcard", g_sd_card, &mount_config, NULL);
    if (ret != ESP_OK) {
        ESP_LOGE(STORAGE_TAG, "SD card format failed: %s", esp_err_to_name(ret));
        g_storage_health.sd_mounted = false;
        return false;
    }
    
    ESP_LOGI(STORAGE_TAG, "✓ SD card formatted successfully");
    g_storage_health.sd_needs_repair = false;
    g_storage_health.sd_errors = 0;
    g_storage_health.sd_mounted = true;
    
    return true;
}

/**
 * @brief Get storage health status
 */
static inline const storage_health_t* storage_health_get_status() {
    return &g_storage_health;
}

/**
 * @brief Run periodic health check
 * Call this from a timer or periodic task
 */
static void storage_health_check() {
    // Auto-repair if needed
    if (g_storage_health.spiffs_needs_repair && g_storage_health.spiffs_mounted) {
        storage_health_repair_spiffs();
    }
    
    if (g_storage_health.sd_needs_repair && g_storage_health.sd_mounted) {
        storage_health_repair_sd();
    }
    
    // Periodic verification
    if (g_storage_health.spiffs_mounted) {
        if (!storage_health_verify_spiffs()) {
            g_storage_health.spiffs_needs_repair = true;
        }
    }
    
    if (g_storage_health.sd_mounted) {
        if (!storage_health_verify_sd()) {
            storage_health_record_sd_error();
        }
    }
}

/**
 * @brief Initialize storage health monitoring
 */
static inline void storage_health_init(bool sd_mounted, bool spiffs_mounted) {
    g_storage_health.sd_mounted = sd_mounted;
    g_storage_health.spiffs_mounted = spiffs_mounted;
    
    ESP_LOGI(STORAGE_TAG, "Storage health monitor initialized (SD:%s, SPIFFS:%s)",
             sd_mounted ? "YES" : "NO", spiffs_mounted ? "YES" : "NO");
}
