name: Build Check

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'webinstaller/**'

env:
  IDF_VERSION: "v5.1.5"

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - device: wt32-sc01-plus
            target: esp32s3
            config: CONFIG_TUX_DEVICE_WT32_SC01_PLUS
            sdkconfig: sdkconfig.defaults.esp32s3
          - device: wt32-sc01
            target: esp32
            config: CONFIG_TUX_DEVICE_WT32_SC01
            sdkconfig: sdkconfig.defaults.esp32

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configure device selection
        run: |
          # Copy appropriate defaults
          cp ${{ matrix.sdkconfig }} sdkconfig.defaults
          
          # Clear all device selections and set the correct one
          echo "" >> sdkconfig.defaults
          echo "# Device selection for CI" >> sdkconfig.defaults
          echo "CONFIG_TUX_DEVICE_WT32_SC01_PLUS=n" >> sdkconfig.defaults
          echo "CONFIG_TUX_DEVICE_WT32_SC01=n" >> sdkconfig.defaults
          echo "CONFIG_TUX_DEVICE_MAKERFABS_S3_PARA=n" >> sdkconfig.defaults
          echo "${{ matrix.config }}=y" >> sdkconfig.defaults
          
          echo "=== sdkconfig.defaults ===" 
          cat sdkconfig.defaults

      - name: Build with ESP-IDF
        uses: espressif/esp-idf-ci-action@v1
        with:
          esp_idf_version: ${{ env.IDF_VERSION }}
          target: ${{ matrix.target }}
          command: idf.py build

      - name: Report build size
        uses: espressif/esp-idf-ci-action@v1
        with:
          esp_idf_version: ${{ env.IDF_VERSION }}
          target: ${{ matrix.target }}
          command: idf.py size
