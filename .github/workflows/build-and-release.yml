name: Build and Release Firmware

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0, v1.2.3
  workflow_dispatch:  # Allow manual trigger
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: false
        default: 'dev'

env:
  IDF_VERSION: "v5.0.7"

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        device:
          - name: wt32-sc01-plus
            target: esp32s3
            config: CONFIG_TUX_DEVICE_WT32_SC01_PLUS
            sdkconfig: sdkconfig.defaults.esp32s3
          - name: wt32-sc01
            target: esp32
            config: CONFIG_TUX_DEVICE_WT32_SC01
            sdkconfig: sdkconfig.defaults.esp32

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup ESP-IDF and Build
        uses: espressif/esp-idf-ci-action@v1
        with:
          esp_idf_version: ${{ env.IDF_VERSION }}
          target: ${{ matrix.device.target }}
          command: |
            cp ${{ matrix.device.sdkconfig }} sdkconfig.defaults.ci
            echo "" >> sdkconfig.defaults.ci
            echo "# Device selection for CI" >> sdkconfig.defaults.ci
            echo "CONFIG_TUX_DEVICE_WT32_SC01_PLUS=n" >> sdkconfig.defaults.ci
            echo "CONFIG_TUX_DEVICE_WT32_SC01=n" >> sdkconfig.defaults.ci
            echo "CONFIG_TUX_DEVICE_MAKERFABS_S3_PARA=n" >> sdkconfig.defaults.ci
            echo "${{ matrix.device.config }}=y" >> sdkconfig.defaults.ci
            cp sdkconfig.defaults.ci sdkconfig.defaults
            idf.py set-target ${{ matrix.device.target }}
            idf.py build

      - name: Prepare artifacts
        run: |
          mkdir -p firmware/${{ matrix.device.name }}
          cp build/bootloader/bootloader.bin firmware/${{ matrix.device.name }}/ || true
          cp build/partition_table/partition-table.bin firmware/${{ matrix.device.name }}/ || true
          cp build/ota_data_initial.bin firmware/${{ matrix.device.name }}/ || true
          cp build/ESP32-TUX.bin firmware/${{ matrix.device.name }}/ || true
          cp build/storage.bin firmware/${{ matrix.device.name }}/ || true
          
          # Create combined binary for easy flashing
          bash -i -c 'esptool.py --chip ${{ matrix.device.target }} merge_bin \
            -o firmware/${{ matrix.device.name }}/ESP32-TUX-${{ matrix.device.name }}-full.bin \
            --flash_mode dio \
            --flash_size detect \
            $(cat build/flash_args | tr '"'"'\n'"'"' '"'"' '"'"') || true'

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.device.name }}
          path: firmware/${{ matrix.device.name }}/
          retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all firmware artifacts
        uses: actions/download-artifact@v4
        with:
          path: firmware-artifacts

      - name: List artifacts
        run: |
          echo "Downloaded artifacts:"
          find firmware-artifacts -type f -name "*.bin" | head -20
          ls -la firmware-artifacts/ 2>/dev/null || echo "No firmware-artifacts dir"

      - name: Prepare release files
        run: |
          mkdir -p release
          
          # Move firmware to proper structure
          for device in wt32-sc01-plus wt32-sc01; do
            if [ -d "firmware-artifacts/firmware-$device" ]; then
              mkdir -p release/$device
              cp -r firmware-artifacts/firmware-$device/* release/$device/
              
              # Create zip for each device
              cd release/$device
              zip -r "../ESP32-TUX-$device-${GITHUB_REF_NAME}.zip" .
              cd ../..
            fi
          done
          
          # List what we created
          ls -la release/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/ESP32-TUX-*.zip
          body: |
            ## ESP32-TUX BambuLab Monitor ${{ github.ref_name }}
            
            ### ðŸš€ Easy Install (Recommended)
            
            **No software needed!** Use our web installer:
            ðŸ‘‰ **[Install via Browser](https://${{ github.repository_owner }}.github.io/ESP32-TUX-BAMBULAB/)**
            
            Just connect your device, click install, and you're done!
            
            ### ðŸ“¦ Manual Download
            
            | Device | Download |
            |--------|----------|
            | WT32-SC01 Plus (ESP32-S3, 8MB) | [Download](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/ESP32-TUX-wt32-sc01-plus-${{ github.ref_name }}.zip) |
            | WT32-SC01 (ESP32, 4MB) | [Download](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/ESP32-TUX-wt32-sc01-${{ github.ref_name }}.zip) |
            
            ### âœ¨ What's New
            
            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-pages:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all firmware artifacts
        uses: actions/download-artifact@v4
        with:
          path: firmware-artifacts

      - name: Prepare GitHub Pages
        run: |
          mkdir -p pages/firmware
          
          # Copy web installer
          cp webinstaller/index.html pages/
          cp webinstaller/manifest-*.json pages/
          
          # Copy firmware binaries
          for device in wt32-sc01-plus wt32-sc01 makerfabs-s3; do
            if [ -d "firmware-artifacts/firmware-$device" ]; then
              mkdir -p pages/firmware/$device
              cp -r firmware-artifacts/firmware-$device/* pages/firmware/$device/
            fi
          done
          
          # Update version in manifests
          VERSION="${GITHUB_REF_NAME#v}"
          for manifest in pages/manifest-*.json; do
            sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" "$manifest"
          done
          
          # Create version file
          echo "$VERSION" > pages/version.txt

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: pages

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
